
name: AI Agent CI/CD

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-test-eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install AJV CLI for JSON Schema validation
      - name: Install AJV
        run: npm install --global ajv ajv-cli

      # Validate all manifests in dev/test/prod using AJV
      - name: Validate agent manifests (AJV)
        run: |
          npx ajv validate -s schemas/agent-manifest.schema.json -d "agents/dev/**/manifest.json"
          npx ajv validate -s schemas/agent-manifest.schema.json -d "agents/test/**/manifest.json"
          npx ajv validate -s schemas/agent-manifest.schema.json -d "agents/prod/**/manifest.json"

      # Unit tests (optional but recommended)
      - name: Run tests
        run: bash scripts/run-tests.sh

      # Golden evals â€” MUST fail CI on regressions
      - name: Run evals
        run: bash scripts/run-evals.sh

      # Nice-to-have: show eval results in Actions Summary
      - name: Summarize evals
        if: always()
        run: |
          echo "### Agent Evals Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f evals/results/latest.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            cat evals/results/latest.json >> $GITHUB_STEP_SUMMARY
          else
            echo "No eval results found." >> $GITHUB_STEP_SUMMARY

  deploy-dev:
    runs-on: ubuntu-latest
    needs: build-test-eval
    if: github.ref == 'refs/heads/main'
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (Dev)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Deploy Dev Agents (Storage + AppConfig)
        env:
          STORAGE_ACCOUNT_DEV: ${{ vars.STORAGE_ACCOUNT_DEV }}
          APPCONFIG_NAME_DEV: ${{ vars.APPCONFIG_NAME_DEV }}
        run: bash scripts/deploy.sh dev

  deploy-test:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: test   # approvals configured in GitHub Environments
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (Test)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: Deploy Test Agents (Storage + AppConfig)
        env:
          STORAGE_ACCOUNT_TEST: ${{ vars.STORAGE_ACCOUNT_TEST }}
          APPCONFIG_NAME_TEST: ${{ vars.APPCONFIG_NAME_TEST }}
        run: bash scripts/deploy.sh test

  deploy-prod:
    runs-on: ubuntu-latest
    needs: deploy-test
    environment: prod   # approvals configured in GitHub Environments
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (Prod)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Deploy Prod Agents (Storage + AppConfig)
        env:
          STORAGE_ACCOUNT_PROD: ${{ vars.STORAGE_ACCOUNT_PROD }}
          APPCONFIG_NAME_PROD: ${{ vars.APPCONFIG_NAME_PROD }}
        run: bash scripts/deploy.sh prod
